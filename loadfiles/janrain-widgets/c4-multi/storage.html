<!doctype html>
<html>
<body>
<script type="text/javascript" src="https://janrain-widgets.s3.amazonaws.com/json/json2-min.js"></script>
<script type="text/javascript">
(function(){

    //allowed domains
    var whiteListedDomains = ["janrain-widgets.s3.amazonaws.com"];

    function isArray(obj) {
        return Object.prototype.toString.call(obj) === "[object Array]";
    }

    function inArray(arr, item) {
        if (!isArray(arr)) return false;
        var 
        i = 0,
        arrLen = arr.length;

        while(i < arrLen){
            if (arr[i] === item){
                return true;
            }
            i++;
        }

        return false;
    }

    function getNewMessage(message) {
        return {
            messageId: message.messageId,
            action: message.action,
            key: message.key,
            storedValue: window.localStorage.getItem(message.key)
        };
    }

    function messageHandler(e) {
        if (e.data.indexOf("janrainCapture:") !== 0) return false;
        if (!inArray(whiteListedDomains, e.origin.replace(/^https?:\/\/|:\d{1,4}$/g, "").toLowerCase())) return false;

        var 
        message = JSON.parse(e.data.replace('janrainCapture:', '')),
        newMessage;

        switch(message.action) {
            case 'set':
                window.localStorage.setItem(message.key, message.value);
                newMessage = getNewMessage(message);
                break;
            case 'remove':
                newMessage = getNewMessage(message);
                window.localStorage.removeItem(message.key);
                break;
            case 'get':
                newMessage = getNewMessage(message);
                break;
        }

        e.source.postMessage('janrainCapture:' + JSON.stringify(newMessage), e.origin);
    }

    function _log(msg){
        if (window.console && window.console.log){
            window.console.log(msg);
        }
    }

    if ( window.addEventListener ) {
        // HTML5
        _log("Setting up event listener 1 remote");
        window.addEventListener("message", messageHandler, false);
    } else if ( window.attachEvent ) {
        // IE
        _log("Setting up event listener 2 remote");
        window.attachEvent("onmessage", messageHandler);
    } else if ( document.attachEvent ) {
        // IE 8
        _log("Setting up event listener 3 remote");
        document.attachEvent("onmessage", messageHandler);
    } else {
        _log("Failed to setup an event listener");
    }

})();
</script>
</body>
</html>
