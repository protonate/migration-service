
<!doctype html>
<html>
<body>
<script type="text/javascript" src="https://d16s8pqtk4uodx.cloudfront.net/json/json2-min.js"></script>
<script type="text/javascript">
(function(){

    //allowed domains
    var whitelist = ["apps.janrain.com", "apps2.janrain.com"];

    function isArray(obj) {
        return Object.prototype.toString.call(obj) === "[object Array]";
    }

    function inArray(arr, item) {
        if (!isArray(arr)) return false;
        var 
        i = 0,
        arrLen = arr.length;

        while(i < arrLen){
            if (arr[i] === item){
                return true;
            }
            i++;
        }

        return false;
    }

    function messageHandler(e) {
        if (e.data.indexOf("janrainCapture:") !== 0) return false;
        if (!inArray(whitelistedDomains, e.origin.replace(/^https?:\/\/|:\d{1,4}$/g, "").toLowerCase())) return false;

        var 
        message = JSON.parse(e.data),
        storedValue = window.localStorage.getItem(message.key),
        newMessage = {
            transactionId: message.transactionId,
            key: message.key,
            storedValue: storedValue
        };

        e.source.postMessage('janrainCapture:' + JSON.stringify(newMessage), e.origin);
    }

    function _log(msg){
        if (window.console && window.console.log){
            window.console.log(msg);
        }
    }

    if ( window.addEventListener ) {
        // HTML5
        _log("Setting up event listener 1");
        window.addEventListener("message", messageHandler, false);
    } else if ( window.attachEvent ) {
        // IE
        _log("Setting up event listener 2");
        window.attachEvent("onmessage", messageHandler);
    } else if ( document.attachEvent ) {
        // IE 8
        _log("Setting up event listener 3");
        document.attachEvent("onmessage", messageHandler);
    } else {
        _log("Failed to setup an event listener");
    }

})();
</script>
</body>
</html>

